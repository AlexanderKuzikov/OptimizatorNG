<!-- Файл: PROJECT.md -->

# Проект: Optimizator Next Gen

> Версия: 0.3.0  
> Последнее обновление: 2025-10-01  
> Статус: Разработка Core слоя  
> Базовый промпт: [PROMPT.md](./PROMPT.md)

## 1. Миссия проекта

Десктопное приложение на Electron + TypeScript для оптимизации и стандартизации шаблонов документов (DOCX/FDT).

**Ключевые особенности:**

- Атомарная архитектура обработки
- Динамический UI на основе config.json
- Гибкая конфигурация без изменения кода
- GitHub-портфолио с высоким качеством кода

## 2. Стек технологий

- **Фреймворк:** Electron
- **Язык:** TypeScript (strict mode)
- **Тестирование:** Jest
- **Сборка:** esbuild, electron-builder
- **Зависимости:** adm-zip
- **Среда:** VS Code, Git (GitHub)
- **Node.js:** LTS версия

## 3. Архитектурные принципы

### Единый источник истины

Вся конфигурация в `config.json`:

- Логика обработки (`processingSteps`)
- Глобальные настройки документов (`documentSettings`)
- Тема интерфейса (`themeSettings`)

### Трёхуровневая архитектура

**Shell (Оболочка):**

- Работа с файловой системой
- Нормализатор: fdt/docx → docx
- Распаковщик/Запаковщик: docx ↔ xml
- Отладочные инструменты

**Orchestrator (Оркестратор):**

- Управление процессом обработки
- Чтение и интерпретация config.json
- Последовательный вызов операций Core
- Передача данных между слоями

**Core (Ядро):**

- Чистые функции обработки XML
- Каждая операция = отдельный файл
- Вход/выход: XML-строка
- Операция: одна задача (обычно RegExp)
- Без побочных эффектов (immutable)

### Динамический UI

- Генерируется на основе метаданных из config.json
- Три уровня доступа:
  - **User:** Минималистичный. Выбор файлов + запуск.
  - **Developer:** Настройка шагов обработки (`processingSteps`)
  - **Settings:** Глобальные настройки документа (`documentSettings`)
- Добавление новой функции в config = автоматическое отображение в UI

## 4. Структура config.json

Три корневых свойства: `themeSettings`, `documentSettings`, `processingSteps`

**Структура атома (операции):**

```json
{
  "id": "removeFonts",
  "name": "Удаление информации о шрифтах",
  "description": "Удаляет блоки <w:fonts> из document.xml",
  "enabled": true,
  "ui": {
    "view": "Developer",
    "group": "Очистка",
    "type": "boolean"
  },
  "params": {}
}
```

**Поля:**

- `id` — уникальный идентификатор, совпадает с именем модуля
- `name` — человекочитаемое имя для UI
- `description` — краткое описание для подсказки
- `enabled` — включена ли операция по умолчанию
- `ui.view` — уровень доступа ('Developer' или 'Settings')
- `ui.group` — группировка в интерфейсе
- `ui.type` — тип элемента управления ('boolean', 'object', 'array')
- `params` — параметры, передаваемые в функцию

## 5. Технические регламенты

### IPC-протокол (Main ↔ Renderer)

**Запуск обработки (Renderer → Main):**

```typescript
window.api.startProcessing(filePaths: string[])
```

**Обновление статуса (Main → Renderer):**

```typescript
{
  channel: 'update-status',
  payload: {
    message: 'Обработка файла report.docx...',
    step: 'Удаление шрифтов',
    progress: 45 // опционально, %
  }
}
```

### Обработка ошибок

- **Пакетный режим:** При ошибке в одном файле — логируем, пропускаем, продолжаем обработку следующего
- **Детальное логирование:** Контекст ошибки для отладки
- **Уведомление пользователя:** Понятное сообщение о проблеме

### Валидация и безопасность

- **Входные данные:** Проверка размера файла, формата, структуры XML
- **IPC:** Whitelist разрешённых каналов в preload, проверка payload в main
- **Пути к файлам:** Защита от path traversal атак
- **contextIsolation:** Включено (true)
- **nodeIntegration:** Выключено (false) в renderer

### Логирование

**Формат:**

```
[2025-10-01T12:34:56.789Z] [removeFonts] Удалено 3 блока шрифтов (42 мс)
[2025-10-01T12:34:57.123Z] [ERROR] [cleanupSpaces] Невалидный XML: ...
```

**Правила:**

- Временная метка ISO
- ID шага операции
- Действие и результат
- Без чувствительных данных
- Детализация для ошибок

### Тестирование

- **Каждая функция Core** имеет файл `*.test.ts`
- **Покрытие:**
  - Стандартное поведение
  - Граничные случаи (пустой файл, большой файл)
  - Некорректные данные
- **Фреймворк:** Jest
- **Запуск:** `npm test`

## 6. Структура проекта

```
optimizatorng/
├── src/
│   ├── main.ts              # Main процесс Electron
│   ├── preload.ts           # Preload скрипт (мост IPC)
│   ├── renderer.ts          # Renderer процесс (UI)
│   ├── shell/               # Уровень "Оболочки"
│   │   ├── normalizer.ts    # fdt/docx → docx
│   │   ├── unpacker.ts      # docx → xml
│   │   └── packer.ts        # xml → docx
│   ├── orchestrator/        # Уровень "Оркестратора"
│   │   ├── processor.ts     # Управление конвейером
│   │   └── configLoader.ts  # Чтение config.json
│   └── core/                # Уровень "Ядра"
│       └── steps/           # Атомарные функции
│           ├── removeFonts.ts
│           ├── removeFonts.test.ts
│           └── ...
├── dist/                    # Скомпилированный код (git ignore)
├── IN/                      # Входные файлы (git ignore)
├── OUT/                     # Выходные файлы (git ignore)
├── docs/                    # Документация
│   ├── PROMPT.md            # Универсальный промпт
│   ├── PROJECT.md           # Этот файл
│   ├── DEV_LOG.md           # История решений
│   └── Glossary.md          # Словарь терминов
├── config.json              # Конфигурация приложения
├── package.json
├── tsconfig.json
├── tsconfig.main.json       # Для main процесса
├── tsconfig.renderer.json   # Для renderer процесса
├── jest.config.js
├── .gitignore
└── README.md
```

## 7. Специфичные требования к коду

### Модули Core (src/core/steps/)

**Шаблон функции:**

```typescript
// Файл: src/core/steps/removeFonts.ts
/**
 * Назначение: Удаление блоков <w:fonts> из document.xml
 *
 * Вход: XML-строка
 * Выход: XML-строка без <w:fonts>
 *
 * Инварианты:
 * - Не изменяет исходную строку (чистая функция)
 * - Всегда возвращает валидный XML
 *
 * Граничные случаи:
 * - XML без <w:fonts> — возвращается без изменений
 * - Множественные блоки <w:fonts> — удаляются все
 *
 * Последнее изменение: 2025-10-01
 */

export function removeFonts(xml: string): string {
  // WHY: Используем RegExp с флагом 'g' для удаления всех вхождений
  const pattern = /<w:fonts>[\s\S]*?<\/w:fonts>/g;
  return xml.replace(pattern, "");
}
```

**Требования:**

- Размер функции: обычно 10–30 строк
- Одна функция = одна задача
- Без внешних зависимостей (кроме стандартных)
- Без состояния (stateless)
- Детерминированность (одинаковый вход → одинаковый выход)

### Модули Orchestrator

- Чтение config.json
- Валидация структуры config
- Последовательный вызов функций Core
- Передача результата между шагами
- Обработка ошибок с продолжением работы

### Модули Shell

- Работа с fs (Node.js)
- Использование adm-zip для распаковки/запаковки
- Валидация форматов файлов
- Создание временных директорий
- Очистка после обработки

## 8. Контекст для восстановления

**Текущая задача:**
[Описание текущей задачи]

**Последние архитектурные решения:**

- [2025-10-01] Разделение промпта на универсальную и проектную части. Обоснование: переиспользование в других проектах.

**Нерешённые вопросы:**

- [ ] Формат хранения истории обработки файлов
- [ ] Механизм отката изменений

**Следующие шаги:**

1. Разработка модулей Shell (normalizer, unpacker, packer)
2. Создание базовых функций Core
3. Реализация Orchestrator

> Подробная история решений в [DEV_LOG.md](./DEV_LOG.md)

## 9. Журнал изменений PROJECT.md

### v0.3.0 (2025-10-01)

- Добавлены специфичные требования к коду
- Расширен раздел структуры проекта
- Добавлены детали IPC-протокола
- Добавлен формат логирования

### v0.2.0 (2025-09-30)

- Разделение на PROMPT.md и PROJECT.md
- Добавлены регламенты безопасности

### v0.1.0 (2025-08-25)

- Первая версия
